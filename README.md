# Клиент BadaPush

## Использование клиента

Клиент используется для отправки push-уведомлений, sms и постановки задач на обзвон, а также получения результатов отправки и обзвона. 

Установка стандартная:

```
composer require druidvav/badapush-client
```

Для каждого из действий нужно создать сервис на сайте badapush.ru и получить API-ключ.

Для работы используются два основных класса

1. `Druidvav\BadapushClient\BadapushQueueClient` — Используется для отправки сообщений через очередь (только push и sms)
2. `Druidvav\BadapushClient\BadapushClient` — Используется для отправки сообщений сразу

### Инициализация клиента

Для симфони выглядит так:

```yaml
queue_client:
  class: Druidvav\BadapushClient\BadapushQueueClient
  arguments: [ "API_KEY" ]
client:
  class: Druidvav\BadapushClient\BadapushClient
  arguments: [ "API_KEY" ]
```

Либо напрямую:

```php
$queueClient = new Druidvav\BadapushClient\BadapushQueueClient("API_KEY");
$client = new Druidvav\BadapushClient\BadapushClient("API_KEY");
```

### Отправка SMS

Отправку SMS рекоммендуем делать через очередь.

```php
use Druidvav\BadapushClient\Payload\Payload; 
// Symfony
$this->get('queue_client')->sendPayload(Payload::create($phoneNumber, $message));
// PHP
$queueClient->sendPayload(Payload::create($phoneNumber, $message));
```

### Отправка пуш уведомлений

// Скоро //

### Отправка задач на обзвон

Отправка задач на обзвон работает только без очереди.

```php
use Druidvav\BadapushClient\Payload\CallerPayload;

$payload = CallerPayload::create($phoneNumber); // Указываем номер телефона, по которому звонить
$payload->setExternalId($externalId); // ID в вашей системе, чтобы вы могли опознать результат обзвона. Например, номер посылки.
$payload->setTimezone($timezone); // Необязательно, часовой пояс клиента в том виде, в каком его отдает dadata.
$payload->setGroup($groupName); // Строка с названием очереди обзвона для разбиения задач на группы. Если разбивка не нужна — укажите одну строку для всех задач.
$payload->setResultOptions([
    'ok' => 'Готово',
    'received' => 'Уже забрал посылку'
]); // Не обязательно, варианты ответа доступные для выбора обзвонщику. Если не указать — будет только ok. Нужно указывать только если вы потом будете обрабатывать результаты обзвона.
$payload->setDataFields([
    'key' => $value,
    'key' => $value
]); // Не обязательно, значения дополнительных полей передаваемых задаче обзвона, подробнее смотри в разделе "Настройка сервисов"
$this->get('client')->sendPayload($payload);
```

### Отмена задач на обзвон

Допустим, вы поставили задачу на уведомление клиента о том, что он не забрал посылку, а он посылку уже забрал. Или на сбор информации, которую вы уже получили. Чтобы обзвонщики не звонили просто так — желательно отменить задачу. Задачи отменяются по `externalID` , если с переданным `externalId` нет задач — ничего страшного. Следить за тем, что задача реально была создана, необязательно.

```php
$this->get('client')->cancelCallsByExternalId($externalId, 'Причина отмены');
```

### Сбор результатов выполнения задач

// Скоро //

## Настройка сервисов в badapush

### Сервис «Badapush Caller»

Сервис для обзвонов — готов к использованию сразу после создания. Если вы хотите добавить дополнительные поля в интерфейс обзвона или добавить ссылку на вашу админку — потребуется настроить поле «Конфигурация полей». Поле должно содержать правильный JSON определенного формата.

Пример:

```json
[
  { "field": "name", "title": "Клиент" },
  { "field": "package_id", "title": "Посылка", "url_field": "package_url" }
]
```

Как видим, здесь указывается массив объектов с определенными полями:

- `field` — значение `key` из примера вызова `setDataFields` вышe.
- `title` — название поля отображаемое обзвонщику в интерфейсе
- `url_field` — значение `key` в котором указывается ссылка, которая будет отображена на значении отображаемом в этом поле. **Внимание!** Первая переданная в задаче ссылка будет отображаться как iframe на странице обзвонщика, чтобы он мог увидеть необходимую информацию из проекта не уходя со страницы обзвона.

Полей может быть сколько угодно, но лучше ограничиться разумным количеством и передать ссылку на админку проекта.

### Сервис APNS

// Скоро //

### Сервис GCM

// Скоро //

### Сервис SmsTraffic

// Скоро //

